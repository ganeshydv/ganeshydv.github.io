# What is MP4?
- Combined storage of - image + Video + subtitless

## Structure of MP4:
## ğŸ”¹ MP4 Structure (ISO Base Media Format - ISO/IEC 14496-12)
- An MP4 file is structured as a hierarchy of atoms (or boxes). Each atom has:

  1. Size (4 bytes) â†’ Indicates the size of the atom.
  1. Type (4 bytes) â†’ A four-character code (e.g., ftyp, moov, mdat).
  1. Payload â†’ Contains the actual data or references to data.
- Atoms can contain other nested atoms, forming a hierarchical structure.

## ğŸ“Œ Key Atoms & Their Order
1ï¸âƒ£ File Type Atom (ftyp) â†’ Always at the beginning

- Identifies the MP4 file format.
- Example: isom, mp42, avc1.
- A player checks this first to verify compatibility.

2ï¸âƒ£ Movie Atom (moov) â†’ Usually after ftyp but before mdat

- Contains metadata like track duration, codecs, sample tables.
- Essential for video playback before loading actual media data.
- Contains track (trak), movie header (mvhd), and sample tables (stbl).

3ï¸âƒ£ Media Data Atom (mdat) â†’ Contains actual video, audio, and subtitle data.

- Can be large, spanning most of the file size.
- Players reference mdat using sample tables from moov.
4ï¸âƒ£ Free Space Atom (free) (optional) â†’ Padding or metadata updates.

5ï¸âƒ£ Metadata Atom (udta) (optional) â†’ User metadata like subtitles, copyright info.
# 
## ğŸ” How Does a Video Player Read MP4?
### 1. Reads ftyp â†’ Confirms MP4 format.
### 2. Reads moov â†’ Extracts:
- Track info (trak) â†’ Finds video, audio, subtitle tracks.
- Sample tables (stbl) â†’ Finds where actual data is in mdat.
- Time scale (timescale) â†’ Determines playback speed.
### 3. Reads mdat â†’ Fetches frames from video/audio/subtitle tracks.
### 4. Decodes frames and renders them in sync.


## ğŸ“Œ Understanding Sample Tables (stbl)
### Inside moov â†’ trak â†’ mdia â†’ minf â†’ stbl, we have:
- Sample Description (stsd) â†’ Codec info (e.g., avc1 for H.264 video).
- Sample Size (stsz) â†’ Size of each frame/sample.
- Chunk Offset (stco or co64) â†’ File positions of media chunks.
- Time-to-Sample (stts) â†’ Playback timing.
### When a player needs the next frame, it:
- Looks at stsz to know frame size.
- Uses stco to locate mdat data.
- Refers to stts to sync audio/video.

## ğŸ“Œ How MP4 Knows Where Video, Audio & Subtitle Are?
#### 1. Multiple trak atoms in moov:

  - One trak for video (hdlr â†’ vide).
  - One trak for audio (hdlr â†’ soun).
  - One trak for subtitles (hdlr â†’ sbtl or subt).
#### 2. Each track has a sample table (stbl) that points to mdat positions.
#### 3. Player decodes & synchronizes tracks using stts (time mapping).

## ğŸ”¹ Real-World Example (MP4 Atom Layout)
```scss
[ftyp] (File Type)
[moov] (Movie Metadata)
  â”œâ”€â”€ [mvhd] (Movie Header)
  â”œâ”€â”€ [trak] (Video Track)
  â”‚    â”œâ”€â”€ [mdia] (Media)
  â”‚         â”œâ”€â”€ [minf] (Media Info)
  â”‚              â”œâ”€â”€ [stbl] (Sample Table)
  â”œâ”€â”€ [trak] (Audio Track)
  â”‚    â”œâ”€â”€ [mdia] (Media)
  â”‚         â”œâ”€â”€ [minf] (Media Info)
  â”‚              â”œâ”€â”€ [stbl] (Sample Table)
[mdat] (Media Data)
```
## ğŸ”¹ Optimizations for Streaming
### 1. Progressive MP4 (Fast Start):

- Moves moov to the beginning so players can start playback before downloading mdat.
### 2. Fragmented MP4 (fMP4):

- Splits video into multiple moof + mdat pairs, useful for adaptive streaming.

## Where 